@model SurveyWeb.Controllers.QuestionCreateViewModel

@{
    ViewData["Title"] = "Thêm câu hỏi";
}

<style>
    .hidden { display: none !important; }
    .option-item { animation: slideIn 0.3s ease-out; }
    @@keyframes slideIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

<div style="max-width: 900px; margin: 0 auto; padding: 1.5rem;">
    <div style="margin-bottom: 1rem;">
        <div style="font-size: 0.75rem; color: #6B7280;">Khảo sát</div>
        <h1 style="font-size: 1.5rem; font-weight: bold; color: #111827;">@Model.SurveyTitle</h1>
    </div>

    <form asp-action="Create"
          asp-route-surveyId="@Model.SurveyId"
          method="post"
          id="questionForm"
          style="background: white; border: 1px solid #E5E7EB; border-radius: 0.75rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 2rem;">

        @Html.AntiForgeryToken()

        <!-- Nội dung câu hỏi -->
        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                📝 Nội dung câu hỏi <span style="color: #DC2626;">*</span>
            </label>
            <textarea name="Text"
                      id="questionText"
                      rows="3"
                      required
                      style="width: 100%; border: 2px solid #D1D5DB; border-radius: 0.5rem; padding: 0.75rem; font-size: 0.875rem; outline: none; transition: border-color 0.2s;"
                      onfocus="this.style.borderColor='#6366F1'"
                      onblur="this.style.borderColor='#D1D5DB'"
                      placeholder="Ví dụ: Bạn hài lòng mức nào với dịch vụ của chúng tôi?">@Model.Text</textarea>
        </div>

        <!-- Loại câu hỏi -->
        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                🎯 Loại câu hỏi <span style="color: #DC2626;">*</span>
            </label>
            <select name="QuestionTypeId"
                    id="questionTypeSelect"
                    required
                    onchange="handleQuestionTypeChange(this)"
                    style="width: 100%; border: 2px solid #D1D5DB; border-radius: 0.5rem; padding: 0.75rem; font-size: 0.875rem; outline: none; background: white; cursor: pointer;">
                <option value="">-- Chọn loại câu hỏi --</option>
                @foreach (var t in Model.AvailableTypes)
                {
                    @if (Model.QuestionTypeId == t.Id)
                    {
                        <option value="@t.Id" 
                                data-code="@t.Code" 
                                data-supports-options="@t.SupportsOptions.ToString().ToLower()"
                                selected>@t.Name</option>
                    }
                    else
                    {
                        <option value="@t.Id" 
                                data-code="@t.Code" 
                                data-supports-options="@t.SupportsOptions.ToString().ToLower()">@t.Name</option>
                    }
                }
            </select>
            <input type="hidden" name="QuestionTypeCode" id="questionTypeCode" />
            <div style="font-size: 0.75rem; color: #6B7280; margin-top: 0.5rem;">
                💡 Chọn loại câu hỏi để hiển thị các tùy chọn phù hợp
            </div>
        </div>

        <!-- Dynamic Options Area -->
        <div id="dynamicOptionsArea" style="margin-bottom: 1.5rem; display: none;">
            
            <!-- MULTIPLE CHOICE / CHECKBOXES / DROPDOWN OPTIONS -->
            <div id="choiceOptionsSection" class="hidden">
                <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.75rem;">
                    ☑️ Các lựa chọn
                </label>
                <div id="optionsList" style="margin-bottom: 0.75rem;">
                    <!-- Options will be added here dynamically -->
                </div>
                <button type="button" 
                        onclick="addOption()"
                        style="padding: 0.5rem 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 0.5rem; font-size: 0.875rem; cursor: pointer; font-weight: 500; box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);">
                    ➕ Thêm lựa chọn
                </button>
            </div>

            <!-- RATING / SLIDER / NPS SECTION -->
            <div id="ratingSection" class="hidden">
                <div style="background: #F9FAFB; border: 2px dashed #E5E7EB; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                    <div style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 1rem;">
                        📊 Cài đặt thang điểm
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div>
                            <label style="display: block; font-size: 0.75rem; font-weight: 500; color: #6B7280; margin-bottom: 0.5rem;">
                                Giá trị tối thiểu
                            </label>
                            <input type="number" 
                                   name="MinValue" 
                                   id="minValue"
                                   value="1"
                                   style="width: 100%; border: 1px solid #D1D5DB; border-radius: 0.375rem; padding: 0.5rem; font-size: 0.875rem;" />
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.75rem; font-weight: 500; color: #6B7280; margin-bottom: 0.5rem;">
                                Giá trị tối đa
                            </label>
                            <input type="number" 
                                   name="MaxValue" 
                                   id="maxValue"
                                   value="5"
                                   style="width: 100%; border: 1px solid #D1D5DB; border-radius: 0.375rem; padding: 0.5rem; font-size: 0.875rem;" />
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.75rem; font-weight: 500; color: #6B7280; margin-bottom: 0.5rem;">
                                Bước nhảy
                            </label>
                            <input type="number" 
                                   name="Step" 
                                   id="stepValue"
                                   value="1"
                                   step="0.1"
                                   style="width: 100%; border: 1px solid #D1D5DB; border-radius: 0.375rem; padding: 0.5rem; font-size: 0.875rem;" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- TEXT INPUT SECTION -->
            <div id="textSection" class="hidden">
                <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                    📏 Số ký tự tối đa
                </label>
                <input type="number" 
                       name="MaxChars" 
                       id="maxChars"
                       placeholder="Ví dụ: 500"
                       style="width: 100%; border: 1px solid #D1D5DB; border-radius: 0.5rem; padding: 0.75rem; font-size: 0.875rem;" />
                <div style="font-size: 0.75rem; color: #6B7280; margin-top: 0.5rem;">
                    💡 Để trống = không giới hạn
                </div>
            </div>

            <!-- UPLOAD FILE SECTION -->
            <div id="uploadSection" class="hidden">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                            📁 Số file tối đa
                        </label>
                        <input type="number" 
                               name="MaxFiles" 
                               placeholder="Ví dụ: 5"
                               style="width: 100%; border: 1px solid #D1D5DB; border-radius: 0.5rem; padding: 0.75rem; font-size: 0.875rem;" />
                    </div>
                    <div>
                        <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                            💾 Kích thước tối đa (MB)
                        </label>
                        <input type="number" 
                               name="MaxFileSizeMB" 
                               placeholder="Ví dụ: 10"
                               style="width: 100%; border: 1px solid #D1D5DB; border-radius: 0.5rem; padding: 0.75rem; font-size: 0.875rem;" />
                    </div>
                </div>
            </div>

        </div>

        <!-- Thứ tự & Bắt buộc -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
            <div>
                <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                    🔢 Thứ tự hiển thị
                </label>
                <input name="OrderNo"
                       type="number"
                       value="@Model.OrderNo"
                       style="width: 100%; border: 1px solid #D1D5DB; border-radius: 0.5rem; padding: 0.75rem; font-size: 0.875rem;"
                       placeholder="0 = tự động" />
                <div style="font-size: 0.75rem; color: #6B7280; margin-top: 0.25rem;">
                    Để 0 để hệ thống tự sắp xếp
                </div>
            </div>

            <div>
                <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                    ⚠️ Bắt buộc trả lời?
                </label>
                <select name="IsRequired"
                        style="width: 100%; border: 1px solid #D1D5DB; border-radius: 0.5rem; padding: 0.75rem; font-size: 0.875rem; background: white; cursor: pointer;">
                    @if (Model.IsRequired)
                    {
                        <option value="false">Không</option>
                        <option value="true" selected>Có</option>
                    }
                    else
                    {
                        <option value="false" selected>Không</option>
                        <option value="true">Có</option>
                    }
                </select>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(ViewData.ModelState.Root?.Errors.FirstOrDefault()?.ErrorMessage))
        {
            <div style="background: #FEE2E2; border: 1px solid #FCA5A5; color: #DC2626; padding: 0.75rem 1rem; border-radius: 0.5rem; font-size: 0.875rem; margin-bottom: 1rem;">
                ⚠️ @ViewData.ModelState.Root.Errors.FirstOrDefault()?.ErrorMessage
            </div>
        }

        <!-- Buttons -->
        <div style="display: flex; justify-content: flex-end; gap: 0.75rem; padding-top: 1.5rem; border-top: 2px solid #F3F4F6;">
            <a href="@Url.Action("List","Question", new { surveyId = Model.SurveyId })"
               style="padding: 0.75rem 1.5rem; border: 2px solid #D1D5DB; border-radius: 0.5rem; color: #374151; font-size: 0.875rem; font-weight: 500; text-decoration: none; display: inline-block;">
                ❌ Hủy
            </a>

            <button type="submit"
                    style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 6px rgba(102, 126, 234, 0.3);">
                💾 Lưu câu hỏi
            </button>
        </div>
    </form>

    <div style="margin-top: 1.5rem;">
        <a style="color: #6366F1; font-size: 0.875rem; font-weight: 500; text-decoration: none;"
           href="@Url.Action("List","Question", new { surveyId = Model.SurveyId })">
            ← Quay lại danh sách câu hỏi
        </a>
    </div>
</div>

<script>
    // Question types configuration
    const QUESTION_TYPE_CONFIG = {
        // Types with multiple choice options
        WITH_OPTIONS: [
            'MULTIPLE_CHOICE', 'CHECKBOXES', 'DROPDOWN', 
            'RANK_ORDER', 'MULTI_LEVEL_DROPDOWN', 'RATE_THE_CHOICE'
        ],
        
        // Types with rating/numeric input
        WITH_RATING: [
            'RATING', 'RATING_SINGLE', 'NPS', 'SLIDER', 
            'RATING_CHECKBOX', 'CONSTANT_SUM'
        ],
        
        // Types with text input
        WITH_TEXT: [
            'SINGLE_TEXTBOX', 'MULTIPLE_TEXTBOX', 
            'PI_EMAIL', 'PI_NAME', 'PI_ADDRESS', 'PI_OCCUPATION'
        ],
        
        // Types with file upload
        WITH_UPLOAD: ['UPLOAD', 'SIGNATURE', 'MEDIA_AI_RECOGNITION']
    };

    let optionCounter = 0;

    function handleQuestionTypeChange(selectElement) {
        const selectedOption = selectElement.options[selectElement.selectedIndex];
        const code = selectedOption.getAttribute('data-code');
        
        // Set hidden field
        document.getElementById('questionTypeCode').value = code || '';
        
        // Hide all sections
        document.getElementById('dynamicOptionsArea').style.display = 'none';
        document.getElementById('choiceOptionsSection').classList.add('hidden');
        document.getElementById('ratingSection').classList.add('hidden');
        document.getElementById('textSection').classList.add('hidden');
        document.getElementById('uploadSection').classList.add('hidden');
        
        if (!code) return;
        
        // Show relevant section
        document.getElementById('dynamicOptionsArea').style.display = 'block';
        
        if (QUESTION_TYPE_CONFIG.WITH_OPTIONS.includes(code)) {
            document.getElementById('choiceOptionsSection').classList.remove('hidden');
            initializeOptions();
        } 
        else if (QUESTION_TYPE_CONFIG.WITH_RATING.includes(code)) {
            document.getElementById('ratingSection').classList.remove('hidden');
        }
        else if (QUESTION_TYPE_CONFIG.WITH_TEXT.includes(code)) {
            document.getElementById('textSection').classList.remove('hidden');
        }
        else if (QUESTION_TYPE_CONFIG.WITH_UPLOAD.includes(code)) {
            document.getElementById('uploadSection').classList.remove('hidden');
        }
    }

    function initializeOptions() {
        const optionsList = document.getElementById('optionsList');
        optionsList.innerHTML = '';
        optionCounter = 0;
        addOption();
        addOption();
    }

    function addOption() {
        const optionsList = document.getElementById('optionsList');
        const newOption = document.createElement('div');
        newOption.className = 'option-item';
        newOption.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.75rem; align-items: center;';
        newOption.innerHTML = `
            <span style="font-weight: 600; color: #6B7280; min-width: 30px;">${optionCounter + 1}.</span>
            <input type="text" 
                   name="Options[${optionCounter}]" 
                   placeholder="Nhập lựa chọn ${optionCounter + 1}"
                   style="flex: 1; border: 1px solid #D1D5DB; border-radius: 0.5rem; padding: 0.75rem; font-size: 0.875rem;" />
            <button type="button" 
                    onclick="removeOption(this)"
                    title="Xóa lựa chọn"
                    style="padding: 0.5rem 0.75rem; background: #FEE2E2; color: #DC2626; border: 1px solid #FCA5A5; border-radius: 0.5rem; cursor: pointer; font-weight: 600;">
                🗑️
            </button>
        `;
        optionsList.appendChild(newOption);
        optionCounter++;
    }

    function removeOption(button) {
        const optionsList = document.getElementById('optionsList');
        if (optionsList.children.length > 1) {
            button.parentElement.remove();
            reindexOptions();
        } else {
            alert('⚠️ Phải có ít nhất 1 lựa chọn!');
        }
    }

    function reindexOptions() {
        const items = document.querySelectorAll('#optionsList .option-item');
        items.forEach((item, index) => {
            const span = item.querySelector('span');
            const input = item.querySelector('input[type="text"]');
            span.textContent = `${index + 1}.`;
            input.name = `Options[${index}]`;
            input.placeholder = `Nhập lựa chọn ${index + 1}`;
        });
        optionCounter = items.length;
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        const selectElement = document.getElementById('questionTypeSelect');
        if (selectElement.value) {
            handleQuestionTypeChange(selectElement);
        }
    });
</script>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")
}
